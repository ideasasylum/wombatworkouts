<%
# Reminders Index View
#
# Displays all reminders for the current user with ability to create, toggle, and delete
# Shows push notification permission status and request if needed
%>

<div class="min-h-screen py-6 md:py-12 px-4 sm:px-6 lg:px-8 w-full" data-controller="push-subscription">
  <div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-h1 text-[rgb(26,26,26)]">Workout Reminders</h1>
    </div>

    <!-- Push Notification Permission Check -->
    <div class="mb-6" data-push-subscription-target="permissionSection">
      <div class="bg-yellow-50 border border-yellow-200 p-4 mb-4 hidden" data-push-subscription-target="permissionWarning">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <%= render "shared/icons/alert", class: "w-5 h-5 text-yellow-600" %>
          </div>
          <div class="ml-3 flex-1">
            <h3 class="text-sm font-medium text-yellow-800 mb-2">Enable Notifications</h3>
            <p class="text-sm text-yellow-700 mb-3">
              Enable notifications to receive workout reminders on this device.
              You can manage notification settings anytime in your browser.
            </p>
            <%= render 'shared/button',
              text: 'Enable Notifications',
              type: :primary,
              size: :small,
              html_options: {
                data: { action: "click->push-subscription#requestPermission" }
              } %>
          </div>
        </div>
      </div>

      <div class="bg-green-50 border border-green-200 p-4 mb-4 hidden" data-push-subscription-target="permissionGranted">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <%= render "shared/icons/check", class: "w-5 h-5 text-green-600" %>
          </div>
          <div class="ml-3">
            <p class="text-sm text-green-700">
              Notifications enabled. You'll receive reminders on this device.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Detected Timezone Display -->
    <% if current_user.timezone.present? %>
      <div class="mb-6 text-sm text-[rgb(107,114,128)]">
        Your timezone: <%= current_user.timezone %>
      </div>
    <% end %>

    <!-- Create Reminder Form -->
    <div class="bg-white border border-[rgb(204,204,204)] p-6 mb-6">
      <h2 class="text-h2 text-[rgb(26,26,26)] mb-4">Create Reminder</h2>

      <%= form_with model: Reminder.new, url: reminders_path, method: :post, class: "space-y-4" do |f| %>
        <!-- Program Selection -->
        <div>
          <%= f.label :program_id, "Program", class: "block text-sm font-medium text-[rgb(26,26,26)] mb-1" %>
          <div class="relative">
            <%= f.collection_select :program_id,
              current_user.programs.order(:title),
              :id,
              :title,
              { prompt: "Select a program" },
              { class: "w-full appearance-none px-3 py-2 pr-10 border border-[rgb(204,204,204)] rounded-sm focus:outline-none focus:ring-2 focus:ring-gray-900 min-h-[44px] bg-white" } %>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
              <%= render "shared/icons/chevron_down", class: "w-5 h-5 text-[rgb(107,114,128)]" %>
            </div>
          </div>
        </div>

        <!-- Days of Week Selection -->
        <div>
          <%= f.label :days_of_week, "Days of Week", class: "block text-sm font-medium text-[rgb(26,26,26)] mb-2" %>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <% Reminder::VALID_DAYS.each do |day| %>
              <label class="relative flex items-center justify-center p-2 border border-[rgb(204,204,204)] rounded-sm cursor-pointer min-h-[44px] transition-colors has-[:checked]:bg-[rgb(26,26,26)] has-[:checked]:text-white has-[:checked]:border-[rgb(26,26,26)] hover:bg-gray-50 has-[:checked]:hover:bg-[rgb(40,40,40)]">
                <%= f.check_box :days_of_week,
                  { multiple: true, checked: false, class: "sr-only" },
                  day,
                  nil %>
                <span class="text-sm font-medium"><%= day.capitalize %></span>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Time Selection -->
        <div>
          <%= f.label :time, "Time", class: "block text-sm font-medium text-[rgb(26,26,26)] mb-1" %>
          <%= f.time_field :time,
            class: "w-full px-3 py-2 border border-[rgb(204,204,204)] rounded-sm focus:outline-none focus:ring-2 focus:ring-gray-900 min-h-[44px]" %>
        </div>

        <!-- Hidden Timezone Field -->
        <%= f.hidden_field :timezone, value: "", data: { "push-subscription-target": "timezoneInput" } %>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <%= render 'shared/button',
            text: 'Create Reminder',
            type: :primary,
            size: :base,
            html_options: {
              type: 'submit'
            } %>
        </div>
      <% end %>
    </div>

    <!-- Reminders List -->
    <% if @reminders.empty? %>
      <div class="bg-white border border-[rgb(204,204,204)] p-12 text-center">
        <div class="max-w-md mx-auto">
          <h2 class="text-h2 text-[rgb(26,26,26)] mb-2">No reminders yet</h2>
          <p class="text-body text-[rgb(107,114,128)]">Create your first reminder to get notifications for your workouts</p>
        </div>
      </div>
    <% else %>
      <div class="space-y-4">
        <% @reminders.each do |reminder| %>
          <div class="bg-white border border-[rgb(204,204,204)] p-4" data-controller="reminder-toggle">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="text-h2 text-[rgb(26,26,26)] mb-2"><%= reminder.program.title %></h3>
                <p class="text-body text-[rgb(107,114,128)] mb-2">
                  <%= reminder.days_of_week.map(&:capitalize).join(", ") %>
                  at <%= reminder.time.strftime("%l:%M %p") %>
                </p>
                <div class="text-sm text-[rgb(107,114,128)]">
                  <%= reminder.timezone %>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <!-- Delete Button -->
                <%= button_to reminder_path(reminder),
                  method: :delete,
                  class: "inline-flex items-center px-3 py-2 text-button text-[rgb(26,26,26)] bg-white hover:bg-gray-50 rounded-sm transition-colors min-h-[44px]",
                  form: { data: { turbo_confirm: "Are you sure you want to delete this reminder?" } } do %>
                  <%= render "shared/icons/trash", class: "w-5 h-5" %>
                <% end %>

              <!-- Toggle Switch -->
              <label class="relative inline-flex items-center cursor-pointer">
                <%= check_box_tag "enabled", "1", reminder.enabled,
                  class: "sr-only peer",
                  data: {
                    "reminder-id": reminder.id,
                    "action": "change->reminder-toggle#toggle"
                  } %>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[rgb(26,26,26)]"></div>
                <span class="ms-3 text-sm text-[rgb(107,114,128)]" data-reminder-toggle-target="statusText">
                  <%= reminder.enabled? ? "On" : "Off" %>
                </span>
              </label>

              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
